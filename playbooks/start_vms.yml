---
- hosts: workstation.example.com
  become: true
  tasks:
    - set_fact: 
        conn_ok: false

    - name: Wait for vCenter port 9443 to be available
      wait_for:
        port: 9443
        host: vcenter.example.com
        delay: 20
        timeout: 1200

    - name: Wait for NFS to be available
      wait_for:
        port: 2049
        host: storage.example.com
        delay: 20

    - name: Wait for ESX and vCenter servers port 443 to be available
      wait_for:
        port: 443
        host: "{{ item }}"
        delay: 20
        timeout: 1200
      with_items:
        - esx1.example.com
        - esx2.example.com
        - vcenter.example.com

    - name: Start db
      include_tasks: loop_db_vms.yml
      until: ansible_facts['conn_ok'] == true
      retries: 20
      delay: 10

    - debug:
        var: conn_ok

    - name: Set powerstate on for ticket-monster vms
      vmware_guest:
        hostname: "{{ vcenter_ip }}"
        username: "{{ vcenter_username }}"
        password: "{{ vcenter_password }}"
        validate_certs: False
        name: "{{ item }}"
        state: poweredon
      delegate_to: localhost
      with_items:
        - jboss0
        - jboss1
        - lb
